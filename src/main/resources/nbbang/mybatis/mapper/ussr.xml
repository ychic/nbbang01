<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="nbbang.mybatis.mapper.ussr">
	<resultMap type="UssrDTO" id="ussrDTOResult">
		<result column="ussrno" property="ussrno"/>
		<result column="ussrtitle" property="ussrtitle"/>
		<result column="ussrcontent" property="ussrcontent"/>
		<result column="ussrpostdate" property="ussrpostdate"/>
		<result column="ussroriginfilenames" property="ussroriginfilenames"/>
		<result column="ussrrealfilenames" property="ussrrealfilenames"/>
		<result column="ussrcategoryname" property="ussrcategoryname"/>
		<result column="navcategory" property="navcategory"/>
		<result column="commentCount" property="commentCount"/>
		<result column="likeCount" property="likeCount"/>
		<collection property="comments" column="ussrno" select="nbbang.mybatis.mapper.ussrcomment.ussrCommentListsUsingCollection" javaType="List" ofType="UssrCommentDTO"/> 
	</resultMap>
	
	<select id="ussrIsLogin" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM member WHERE email=#{email} AND password=#{password}		
	</select>
	
	<select id="ussrRecommandSelectList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='recommand'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>
				ORDER BY ussrno DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
			<!-- <if test='navcategoryData.equals("구독서비스 추천")'> AND navcategory='recommandService'</if>
			<if test="navcategoryData=='컨텐츠 추천'"> AND navcategory='recommandContents'</if>
			<if test="navcategoryData=='꿀팁 추천'"> AND navcategory='recommandTips'</if> -->
	</select>
	<select id="recommandLikeSortList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='recommand'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>
				ORDER BY likeCount DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	<select id="recommandServiceList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='recommand' AND navcategory='recommandService'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>
				ORDER BY ussrno DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	<select id="recommandContentsList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='recommand' AND navcategory='recommandContents'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>
				ORDER BY ussrno DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	<select id="recommandTipsList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='recommand' AND navcategory='recommandTips'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>			
				ORDER BY ussrno DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	
	<select id="ussrFreeSelectList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='free'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>
				ORDER BY ussrno DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	<select id="freeLikeSortList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='free'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>			
				ORDER BY likeCount DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	<select id="freeNormalList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='free' AND navcategory='freeNormal'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>
				ORDER BY ussrno DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	<select id="freeReviewList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='free' AND navcategory='freeReview'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>
				ORDER BY ussrno DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	<select id="freeInfoList" parameterType="Map" resultType="UssrDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM
			(SELECT u.*,m.nickname,(SELECT COUNT(*) FROM ussrcomment WHERE ussrno=u.ussrno) as commentCount, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM 
				ussrbbs u JOIN member m ON m.email=u.email
				WHERE ussrcategoryname='free' AND navcategory='freeInfo'
				<if test="searchWord !=null">
					AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
				</if>
				ORDER BY ussrno DESC) T)
		WHERE R BETWEEN #{start} AND #{end}
	</select>
	
	<select id="ussrTotalRowCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM ussrbbs u JOIN member m ON m.email=u.email
		WHERE ussrcategoryname='recommand'
		<if test="nav != null">
			AND navcategory = #{nav}
		</if>		
		<if test="searchWord !=null">
			AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
		</if>
	</select>
	<select id="freeTotalRowCount" parameterType="Map" resultType="int">
  		SELECT COUNT(*) FROM ussrbbs u JOIN member m ON m.email=u.email
		WHERE ussrcategoryname='free'
		<if test="nav != null">
			AND navcategory = #{nav}
		</if>		
		<if test="searchWord !=null">
			AND ${searchColumn} LIKE '%' || #{searchWord} || '%'
		</if>
  	</select>
  	
	<insert id="ussrInsert" parameterType="Map" >
		INSERT INTO ussrbbs
		VALUES(SEQ_ussrbbs_ussrno.NEXTVAL,#{ussrtitle},#{ussrcontent},SYSDATE, null, null,#{ussrcategoryname},#{email},#{navcategory})
	</insert>
	
	<select id="ussrSelectOne" parameterType="Map" resultMap="ussrDTOResult">
		SELECT u.*,m.nickname, (SELECT COUNT(*) FROM ussrlike l WHERE l.ussrno = u.ussrno) likeCount FROM member m JOIN ussrbbs u ON m.email=u.email WHERE ussrno=#{ussrno}
	</select>
	
	<select id="ussrFindNicknameByEmail" parameterType="String" resultType="String">
		SELECT nickname FROM member WHERE email=#{email}
	</select>
	
	<update id="ussrUpdate" parameterType="Map">
		UPDATE ussrbbs SET ussrtitle=#{ussrtitle},ussrcontent=#{ussrcontent},ussrcategoryname=#{ussrcategoryname},navcategory=#{navcategory} WHERE ussrno=#{ussrno}
	</update>
	
	<delete id="ussrDelete" parameterType="Map">
		DELETE ussrbbs WHERE ussrno=#{ussrno}
	</delete>
  	
  	<insert id="likeInsert" parameterType="Map">
		INSERT INTO ussrlike
		VALUES(SEQ_ussrlike_likeno.NEXTVAL,#{ussrno},#{email})
	</insert>
  	
  	<select id="likeCount" parameterType="Map" resultType="int">
  		select count(*) from ussrlike where email=#{email} and ussrno=#{ussrno}
  	</select>
  	
</mapper>